INFO:     Started server process [80353]
INFO:     Waiting for application startup.
Capability detection skipped due to error: Multiple exceptions: [Errno 61] Connect call failed ('::1', 8543, 0, 0), [Errno 61] Connect call failed ('127.0.0.1', 8543)
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:38273 (Press CTRL+C to quit)
INFO:     127.0.0.1:49635 - "GET /health HTTP/1.1" 200 OK
Primary DB connection failed (OSError). Falling back to SQLite.
Primary DB connection failed (OSError). Falling back to SQLite.
Search query failed: (sqlite3.OperationalError) no such table: products
[SQL: 
        SELECT DISTINCT
            p.id,
            p.name,
            pp.id as offer_id,
            pp.pharmacy_name,
            pp.address,
            pp.price,
            pp.unit,
            pp.expiration,
            pp.fetched_at,
            pp.pharmacy_lat,
            pp.pharmacy_lon,
            pp.map_url
        FROM products p
        INNER JOIN pharmacy_prices pp ON p.id = pp.product_id
        WHERE p.active = true
     AND LOWER(pp.address) LIKE LOWER(?) ORDER BY pp.price ASC LIMIT ? OFFSET ?]
[parameters: ('%Kraków%', 10, 0)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Stats query failed: (sqlite3.OperationalError) no such table: products
[SQL: 
                    SELECT COUNT(DISTINCT p.id)
                    FROM products p
                    JOIN pharmacy_prices pp ON p.id = pp.product_id
                    WHERE p.active = true AND LOWER(pp.address) LIKE LOWER(?)
                    ]
[parameters: ('%Kraków%',)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO:     127.0.0.1:49636 - "GET /api/search?city=Krak%C3%B3w&sort_by=price&sort_order=asc&limit=10 HTTP/1.1" 200 OK
INFO:     127.0.0.1:49639 - "GET /api/stats?city=Krak%C3%B3w HTTP/1.1" 200 OK
Primary DB connection failed (OSError). Falling back to SQLite.
Stats query failed: (sqlite3.OperationalError) no such table: products
[SQL: 
                    SELECT COUNT(DISTINCT p.id)
                    FROM products p
                    JOIN pharmacy_prices pp ON p.id = pp.product_id
                    WHERE p.active = true
                    ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO:     127.0.0.1:49642 - "GET /api/stats HTTP/1.1" 200 OK
Primary DB connection failed (OSError). Falling back to SQLite.
Stats query failed: (sqlite3.OperationalError) no such table: products
[SQL: 
                    SELECT COUNT(DISTINCT p.id)
                    FROM products p
                    JOIN pharmacy_prices pp ON p.id = pp.product_id
                    WHERE p.active = true
                    ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO:     127.0.0.1:49645 - "GET /api/stats HTTP/1.1" 200 OK
Primary DB connection failed (OSError). Falling back to SQLite.
Cities query failed: (sqlite3.OperationalError) no such table: pharmacy_prices
[SQL: 
            SELECT 
                address,
                COUNT(DISTINCT pharmacy_name) as pharmacy_count,
                AVG(price) as avg_price
            FROM pharmacy_prices 
            WHERE address IS NOT NULL 
            GROUP BY address 
        ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO:     127.0.0.1:49648 - "GET /api/cities_stats HTTP/1.1" 200 OK
Primary DB connection failed (OSError). Falling back to SQLite.
Cities query failed: (sqlite3.OperationalError) no such table: pharmacy_prices
[SQL: 
            SELECT 
                address,
                COUNT(DISTINCT pharmacy_name) as pharmacy_count,
                AVG(price) as avg_price
            FROM pharmacy_prices 
            WHERE address IS NOT NULL 
            GROUP BY address 
        ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO:     127.0.0.1:49651 - "GET /api/cities_stats HTTP/1.1" 200 OK
Primary DB connection failed (OSError). Falling back to SQLite.
Cities query failed: (sqlite3.OperationalError) no such table: pharmacy_prices
[SQL: 
            SELECT 
                address,
                COUNT(DISTINCT pharmacy_name) as pharmacy_count,
                AVG(price) as avg_price
            FROM pharmacy_prices 
            WHERE address IS NOT NULL 
            GROUP BY address 
        ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO:     127.0.0.1:49671 - "GET /api/capabilities HTTP/1.1" 200 OK
INFO:     127.0.0.1:49667 - "GET /api/cities_stats HTTP/1.1" 200 OK
Primary DB connection failed (OSError). Falling back to SQLite.
Primary DB connection failed (OSError). Falling back to SQLite.
Primary DB connection failed (OSError). Falling back to SQLite.
Search query failed: (sqlite3.OperationalError) no such table: products
[SQL: 
        SELECT DISTINCT
            p.id,
            p.name,
            pp.id as offer_id,
            pp.pharmacy_name,
            pp.address,
            pp.price,
            pp.unit,
            pp.expiration,
            pp.fetched_at,
            pp.pharmacy_lat,
            pp.pharmacy_lon,
            pp.map_url
        FROM products p
        INNER JOIN pharmacy_prices pp ON p.id = pp.product_id
        WHERE p.active = true
     ORDER BY pp.price ASC LIMIT ? OFFSET ?]
[parameters: (10, 0)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
Stats query failed: (sqlite3.OperationalError) no such table: products
[SQL: 
                    SELECT COUNT(DISTINCT p.id)
                    FROM products p
                    JOIN pharmacy_prices pp ON p.id = pp.product_id
                    WHERE p.active = true
                    ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
SQLite fallback connection failed: (sqlite3.OperationalError) no such table: products
[SQL: SELECT DISTINCT id, name FROM products WHERE active = true]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO:     127.0.0.1:49670 - "GET /api/products HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 177, in execute
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 337, in _handle_exception
    raise error
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 159, in execute
    self.await_(_cursor.execute(operation, parameters))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/aiosqlite/cursor.py", line 40, in execute
    await self._execute(self._cursor.execute, sql, parameters)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/aiosqlite/cursor.py", line 32, in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/aiosqlite/core.py", line 122, in _execute
    return await future
           ^^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/aiosqlite/core.py", line 105, in run
    result = function()
sqlite3.OperationalError: no such table: products

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/uvicorn/protocols/http/h11_impl.py", line 403, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        self.scope, self.receive, self.send
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/middleware/cors.py", line 93, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/middleware/cors.py", line 144, in simple_response
    await self.app(scope, receive, send)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/starlette/routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/fastapi/routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    )
    ^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/fastapi/routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gniewko/Repos/Scraper/backend/routes/products.py", line 50, in get_products
    await conn.execute(
        text("SELECT DISTINCT id, name FROM products WHERE active = true")
    )
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/engine.py", line 658, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
    ...<5 lines>...
    )
    ^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 177, in execute
    self._adapt_connection._handle_exception(error)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 337, in _handle_exception
    raise error
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 159, in execute
    self.await_(_cursor.execute(operation, parameters))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/aiosqlite/cursor.py", line 40, in execute
    await self._execute(self._cursor.execute, sql, parameters)
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/aiosqlite/cursor.py", line 32, in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/aiosqlite/core.py", line 122, in _execute
    return await future
           ^^^^^^^^^^^^
  File "/Users/gniewko/.virtualenvs/Scraper/lib/python3.13/site-packages/aiosqlite/core.py", line 105, in run
    result = function()
sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: products
[SQL: SELECT DISTINCT id, name FROM products WHERE active = true]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO:     127.0.0.1:49673 - "GET /api/search?sort_by=price&sort_order=asc&limit=10 HTTP/1.1" 200 OK
INFO:     127.0.0.1:49672 - "GET /api/stats HTTP/1.1" 200 OK
Primary DB connection failed (OSError). Falling back to SQLite.
Stats query failed: (sqlite3.OperationalError) no such table: products
[SQL: 
                    SELECT COUNT(DISTINCT p.id)
                    FROM products p
                    JOIN pharmacy_prices pp ON p.id = pp.product_id
                    WHERE p.active = true
                    ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
INFO:     127.0.0.1:49671 - "GET /api/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:49824 - "GET /api/capabilities HTTP/1.1" 200 OK
INFO:     127.0.0.1:49822 - "GET /api/cities_stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:49823 - "GET /api/products HTTP/1.1" 200 OK
INFO:     127.0.0.1:49825 - "GET /api/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:49826 - "GET /api/search?sort_by=price&sort_order=asc&limit=10 HTTP/1.1" 200 OK
INFO:     127.0.0.1:49824 - "GET /api/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:50210 - "GET /api/capabilities HTTP/1.1" 200 OK
INFO:     127.0.0.1:50208 - "GET /api/cities_stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:50209 - "GET /api/products HTTP/1.1" 200 OK
INFO:     127.0.0.1:50212 - "GET /api/search?sort_by=price&sort_order=asc&limit=10 HTTP/1.1" 200 OK
INFO:     127.0.0.1:50211 - "GET /api/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:50213 - "GET /api/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:50210 - "GET /api/search?sort_by=price&sort_order=asc&limit=10 HTTP/1.1" 200 OK
INFO:     127.0.0.1:50208 - "GET /api/stats HTTP/1.1" 200 OK
