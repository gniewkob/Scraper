name: CI (scraper)

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  commitlint:
    name: PR Title (Conventional Commits)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm i -D @commitlint/cli @commitlint/config-conventional
      - name: Lint PR title
        if: github.event_name == 'pull_request'
        run: echo "${{ github.event.pull_request.title }}" | npx commitlint
      - name: Skip on push (no PR)
        if: github.event_name == 'push'
        run: echo "Skipping commitlint on push"

  lint_and_test:
    name: Lint & Tests (py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: commitlint
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']

    env:
      CI: true
      HEADLESS: true
      DB_URL: sqlite+aiosqlite:///tmp/test.db

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 2 }

      # --- Python ---
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: >-
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ hashFiles('**/requirements*.txt') }}-
            ${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Upgrade pip tooling
        run: python -m pip install --upgrade pip wheel setuptools

      - name: Install Python dependencies
        run: |
          if [ -f "requirements-ci.txt" ]; then pip install -r requirements-ci.txt; fi
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          # WAŻNE: zapewnij Selenium Managera
          pip install "selenium>=4.12" ruff pytest pytest-cov
          pip install mypy || true

      # --- Systemowe biblioteki dla Chrome (Ubuntu 24.04) ---
      - name: Install system deps for headless browsers
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libxss1 libnss3 libasound2t64 libgbm1 libu2f-udev \
            fonts-liberation xdg-utils xvfb

      # --- Chrome for Testing (z pasującym driverem zarządzanym przez Selenium Manager) ---
      - name: Setup Chrome (Chrome for Testing)
        id: chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Export CHROME_BIN
        run: echo "CHROME_BIN=${{ steps.chrome.outputs.chrome-path }}" >> $GITHUB_ENV

      - name: Verify Chrome
        run: |
          "${{ steps.chrome.outputs.chrome-path }}" --version

      # --- Node (globalny cache dla root + frontend) ---
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            package-lock.json
            frontend/package-lock.json

      - name: Install backend deps (root)
        if: hashFiles('package-lock.json') != ''
        run: npm ci

      - name: Install frontend deps
        if: hashFiles('frontend/package-lock.json') != ''
        working-directory: frontend
        run: npm ci

      # --- Lint / Types ---
      - name: Ruff (lint)
        run: ruff check .
      - name: mypy (optional)
        run: |
          if [ -f "mypy.ini" ] || grep -q "\[tool\.mypy\]" pyproject.toml 2>/dev/null; then
            mypy .
          else
            echo "No mypy config found — skipping."
          fi
        continue-on-error: true

      # --- Testy ---
      # Jeśli Twoje testy wymagają wirtualnego ekranu, odkomentuj:
      # - name: Run tests (with Xvfb)
      #   run: xvfb-run -a bash scripts/run_ci_tests.sh
      - name: Run tests
        run: bash scripts/run_ci_tests.sh

      # --- Artefakty ---
      - name: Upload coverage
        if: always() && hashFiles('**/coverage.xml') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: "**/coverage.xml"
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload junit
        if: always() && hashFiles('**/junit*.xml') != ''
        uses: actions/upload-artifact@v4
        with:
          name: junit-${{ matrix.python-version }}
          path: |
            **/junit*.xml
            **/test-results/**/*.xml
          if-no-files-found: ignore
          retention-days: 7
