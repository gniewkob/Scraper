name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

# Anuluj starsze joby dla tego samego PR/brancha
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  commitlint:
    name: Commitlint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # dla commitlinta potrzebujemy historii
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install commitlint
        run: npm i -D @commitlint/cli @commitlint/config-conventional

      # Zakres:
      # - dla PR: od base SHA do HEAD (wszystkie commity w PR)
      # - dla push: różnica względem poprzedniego refa
      - name: Lint commits (PR)
        if: github.event_name == 'pull_request'
        run: |
          npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.sha }}
      - name: Lint commits (push)
        if: github.event_name == 'push'
        run: |
          BASE="$(git rev-parse ${{ github.event.before }})"
          HEAD="${{ github.sha }}"
          npx commitlint --from "$BASE" --to "$HEAD"

  test:
    name: Lint & Tests (py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: commitlint
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    env:
      CI: true
      HEADLESS: true
      DB_URL: sqlite+aiosqlite:///tmp/test.db

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Cache pip (extra safety)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: >-
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ hashFiles('**/requirements*.txt') }}-
            ${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip wheel setuptools
          if [ -f "requirements-ci.txt" ]; then
            pip install -r requirements-ci.txt
          fi
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
          # narzędzia CI, jeśli nie masz w requirements
          pip install ruff pytest pytest-cov
          pip install mypy || true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      - name: Ruff (lint)
        run: ruff check .
        continue-on-error: false

      - name: mypy (optional)
        run: |
          if [ -f "mypy.ini" ] || grep -q "\[tool\.mypy\]" pyproject.toml 2>/dev/null; then
            mypy .
          else
            echo "No mypy config found — skipping."
          fi
        continue-on-error: true

      - name: Run tests
        run: bash scripts/run_ci_tests.sh

      # Artefakty testów/coverage (jeśli Twój skrypt je tworzy)
      - name: Upload coverage
        if: always() && hashFiles('**/coverage.xml') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: |
            **/coverage.xml
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload junit
        if: always() && hashFiles('**/junit*.xml') != ''
        uses: actions/upload-artifact@v4
        with:
          name: junit-${{ matrix.python-version }}
          path: |
            **/junit*.xml
            **/test-results/**/*.xml
          if-no-files-found: ignore
          retention-days: 7
