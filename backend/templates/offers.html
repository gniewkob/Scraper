<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Wszystkie oferty</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { background-color: #121212; color: #f1f1f1; }
    .card, .table, .form-control, .form-label, .btn { background-color: #1e1e1e; color: #f1f1f1; }
    .card { border: 1px solid #2c2c2c; }
    .table th, .table td { vertical-align: middle; }
    .btn-outline-light { color: #f1f1f1; border-color: #ccc; }
    .btn-outline-light:hover { background-color: #1e1e1e; border-color: #f1f1f1; }
  </style>
</head>
<body>
<div id="loadingIndicator" class="spinner-border text-light" role="status" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:2000;">
  <span class="visually-hidden">Loading...</span>
</div>
<div class="container py-4">
  <h1 class="text-center mb-4">ðŸŒ¿ Wszystkie oferty</h1>
  <div class="row mb-3">
    <div class="col-md-4 mb-2 mb-md-0">
      <label for="productSelect" class="form-label">Wybierz produkt:</label>
      <select id="productSelect" class="form-select"></select>
    </div>
    <div class="col-md-4">
      <label for="sortSelect" class="form-label">Sortuj po:</label>
      <select id="sortSelect" class="form-select form-select-sm">
        <option value="price">Cena</option>
        <option value="expiration">WaÅ¼noÅ›Ä‡</option>
        <option value="fetched_at">Data pobrania</option>
      </select>
    </div>
    <div class="col-md-4">
      <label for="orderSelect" class="form-label">KolejnoÅ›Ä‡:</label>
      <select id="orderSelect" class="form-select form-select-sm">
        <option value="asc">RosnÄ…co</option>
        <option value="desc">MalejÄ…co</option>
      </select>
    </div>
  </div>
  <div id="allOffersTable"></div>
  <div id="pagination" class="my-3"></div>
  <div id="countInfo" class="mb-2 text-muted"></div>
</div>
<script src="/static/dashboard.combined.js"></script>
<script>
let currentProduct = '';
let currentOffset = 0;
let currentLimit = 20;
let currentSort = 'price';
let currentOrder = 'asc';

async function loadProductsAll() {
  showLoading();
  try {
    const res = await fetch('/api/products');
    const products = await res.json();
    const sel = document.getElementById('productSelect');
    sel.innerHTML = '';
    products.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.name;
      opt.textContent = p.label;
      sel.appendChild(opt);
    });
    if (products.length > 0) {
      currentProduct = products[0].name;
      sel.value = currentProduct;
      loadAllOffers();
    }
  } catch (e) {
    console.error(e);
  } finally {
    hideLoading();
  }
}

document.getElementById('productSelect').onchange = function() {
  currentProduct = this.value;
  currentOffset = 0;
  loadAllOffers();
};

document.getElementById('sortSelect').onchange = function() {
  currentSort = this.value;
  currentOffset = 0;
  loadAllOffers();
};

document.getElementById('orderSelect').onchange = function() {
  currentOrder = this.value;
  currentOffset = 0;
  loadAllOffers();
};

function renderAllPagination(total, limit, offset) {
  const totalPages = Math.ceil(total / limit);
  const currentPage = Math.floor(offset / limit) + 1;
  const paginationDiv = document.getElementById('pagination');
  paginationDiv.innerHTML = '';
  if (totalPages <= 1) return;
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline-light btn-sm mx-1';
    btn.textContent = i;
    if (i === currentPage) btn.disabled = true;
    btn.onclick = () => {
      currentOffset = (i - 1) * limit;
      loadAllOffers();
    };
    paginationDiv.appendChild(btn);
  }
}

function renderAllCountInfo(total, limit, offset) {
  const countInfo = document.getElementById('countInfo');
  const first = offset + 1;
  const last = Math.min(offset + limit, total);
  countInfo.textContent = `WyÅ›wietlasz ${first}â€“${last} z ${total} ofert`;
}

async function loadAllOffers() {
  showLoading();
  try {
    let url = `/api/product/${encodeURIComponent(currentProduct)}?limit=${currentLimit}&offset=${currentOffset}`;
    url += `&sort=${currentSort}&order=${currentOrder}`;
    const res = await fetch(url);
    const data = await res.json();
    currentLimit = data.limit;
    currentOffset = data.offset;
    renderAllProductOffers(data.offers);
    renderAllPagination(data.total, data.limit, data.offset);
    renderAllCountInfo(data.total, data.limit, data.offset);
  } catch (e) {
    console.error(e);
  } finally {
    hideLoading();
  }
}

window.addEventListener('DOMContentLoaded', loadProductsAll);
</script>
</body>
</html>
